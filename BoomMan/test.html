<!DOCTYPE html>
<html>

<head>
    <title>Page Title</title>
    <script>

        const HEIGHT = window.innerHeight;
        const WIDTH = window.innerWidth;
        let uuid = 1000;

        class __TIME {
            constructor(rate = 33) {
                let self = this;
                self._timeList = [];
                self._rate = rate;

                self._timer = setInterval(self._calculate.bind(self), rate);
            }

            on(event, id) {
                this._timeList.push({
                    id: id,
                    event: event
                });
            }

            off(id) {
                let list = this._timeList;
                for (const index in list) {
                    let event = list[index];
                    if (event.id == id) {
                        list.splice(index, 1);
                    }
                }
            }

            freeze() {
                clearInterval(this._timer);
            }

            unfreeze() {
                let self = this;
                self._timer = setInterval(self._calculate.bind(self), self._rate);
            }

            _calculate() {
                this._timeList.forEach(element => {
                    element['event']();
                });
            }
        }

        class __WORLD {
            constructor(width, height) {

                let canvas = document.createElement('canvas');
                this._universe = window;
                this._canvas = canvas;
                this._width = width;
                this._height = height;
                this._worldBrush = canvas.getContext("2d");
                this._objectList = [];

                this.loaded = undefined;

                this._drawEffectMap = {};

                this.init();
            }

            init() {
                let self = this;
                TIME.on(() => {
                    if (document && document.body) {
                        document.body.append(self._canvas);
                        self._canvas.style.width = self._width;
                        self._canvas.style.height = self._height;
                        self._canvas.style.position = "absolute";
                        self._canvas.style.top = "0px";
                        self._canvas.style.left = "0px";
                        self._canvas.width = self._width;
                        self._canvas.height = self._height;
                        self.initEvent();
                        TIME.off('createEarth');
                    }
                }, 'createEarth');
            }

            initEvent() {
                let self = this;
                TIME.on(self.clearWorld.bind(self), 'clearWorld');

                if (typeof self.loaded == 'function') {
                    self.loaded();
                }

            }

            clearWorld() {
                this._worldBrush.clearRect(0, 0, this.rangeX, this.rangeY);
            }

            drawEffectLine() {
                let self = this;
                self._worldBrush.lineWidth = 0.5;
                for (const key in self._drawEffectMap) {
                    if (self._drawEffectMap.hasOwnProperty(key)) {
                        const element = self._drawEffectMap[key];

                        if (element.isCSP) {
                            self._worldBrush.strokeStyle = "#f9b4b6";
                        } else {
                            self._worldBrush.strokeStyle = "#81D8D0";
                        }
                self._worldBrush.beginPath();
                        self._worldBrush.moveTo(element.x1, element.y1);
                        self._worldBrush.lineTo(element.x2, element.y2);
                        self._worldBrush.stroke();
                self._worldBrush.closePath();
                    }
                }
                self._drawEffectMap = {};
            }

            set rangeX(x) {
                this._width = x;
            }

            set rangeY(y) {
                this._height = y;
            }

            get rangeX() {
                return this._width;
            }

            get rangeY() {
                return this._height;
            }

            get earth() {
                return this._canvas;
            }

            add(object) {
                var self = this;
                TIME.off('connectLine');
                if (object._uid == "superPower") {
                    self._objectList.unshift(object);
                } else {
                    self._objectList.push(object);
                }
                TIME.on(self._checkEffect.bind(self), 'connectLine');
            }

            remove(object) {
                var self = this;
                var index = self._objectList.indexOf(object);
                if (index >= 0) {
                    TIME.off('connectLine');
                    self._objectList.splice(index, 1);
                    object.destroy();
                    TIME.on(self._checkEffect.bind(self), 'connectLine');
                }
            }

            _checkConnect(obj1, obj2) {
                let x1 = obj1.x;
                let y1 = obj1.y;
                let e1 = obj1.effectRange;
                let id1 = obj1._uid;
                let x2 = obj2.x;
                let y2 = obj2.y;
                let e2 = obj2.effectRange;
                let id2 = obj2._uid;
                let e = Math.min(e1, e2);
                let d = Math.pow((y2 - y1), 2) + Math.pow((x2 - x1), 2);
                d = Math.sqrt(d);
                if (e > d) {
                    // superPower 永远在list的第一位，传染又是从0开始，所以只需要看obj1就行
                    if (obj1.isCSP || obj2.isCSP) {
                        obj1.isCSP = true;
                        obj2.isCSP = true;
                    }
                    let id = id1 < id2 ? id1 + "" + id2 : id2 + "" + id1;
                    let drawMap = this._drawEffectMap[id];
                    if(!drawMap || !drawMap.isCSP){
                        this._drawEffectMap[id] = {
                            x1: x1,
                            y1: y1,
                            x2: x2,
                            y2: y2,
                            isCSP: obj1.isCSP
                        };
                    }
                }
            }

            _checkEffect() {
                let self = this;
                let list = self._objectList;
                for (let i = 0; i < list.length; i++) {
                    if (list[i]._uid == 'superPower') {
                        list[i].isCSP = true;
                    } else {
                        list[i].isCSP = false;
                    }
                }
                for (let i = 0; i < list.length; i++) {
                    const ele1 = list[i];
                    for (let j = i + 1; j < list.length; j++) {
                        const ele2 = list[j];
                        self._checkConnect(ele1, ele2);
                    }
                }
                self.drawEffectLine();
            }

        }

        class WORLDRULE {
            constructor() {
                let self = this;
                self.context = null;
                self._uid = (uuid++);
                self._x = 0;
                self._y = 0;
                self._range = 0;
                self.speedX = 0;
                self.speedY = 0;
                self._effectRange = 100;
                this._World = {
                    width: 0,
                    height: 0
                }

                self.initEvent();
            }
            initEvent() {
                let self = this;
                TIME.on(self.calculate.bind(self), 'objectMove' + self._uid);
            }
            get x() {
                return this._x;
            }

            get y() {
                return this._y;
            }

            get speed() {
                return {
                    x: this.speedX,
                    y: this.speedY
                }
            }

            set World(world) {
                this._World = world;
            }

            calculate() {
                let self = this;
                var result, calX, calY;
                if (!self.context) {
                    return;
                }

                result = self.checkHit();
                if (result.indexOf('+x') != -1) {
                    // 触发碰撞后，先移动后，后改速度
                    calX = (2 * (self._World.rangeX - self._range) - self._x - self.speedX);
                    this.addSpeedX(-2 * this.speedX);
                } else if (result.indexOf('-x') != -1) {
                    // 触发碰撞后，先移动后，后改速度
                    calX = (2 * self._range - self.speedX - self._x);
                    this.addSpeedX(-2 * this.speedX);
                } else {
                    calX = self._x + self.speedX;
                }

                if (result.indexOf('+y') != -1) {
                    // 触发碰撞后，先移动后，后改速度
                    calY = (2 * (self._World.rangeY - self._range) - self._y - self.speedY);
                    this.addSpeedY(-2 * this.speedY);
                } else if (result.indexOf('-y') != -1) {
                    // 触发碰撞后，先移动后，后改速度
                    calY = (2 * self._range - self.speedY - self._y);
                    this.addSpeedY(-2 * this.speedY);
                } else {
                    calY = self._y + self.speedY;
                }

                // 移动
                // self.context.clearRect(self._x - self._range, self._y - self._range, 2 * self._range, 2 * self._range);
                self._x = calX;
                self._y = calY;
                self.move();
            }

            addSpeedX(x) {
                // console.log('%s add x Speed: %s', this._uid, x);
                this.speedX += x;
            }

            addSpeedY(y) {
                // console.log('%s add y Speed: %s', this._uid, y);
                this.speedY += y;
            }

            checkHit() {
                let self = this;
                var rangeX = self._World.rangeX - self._range;
                var rangeY = self._World.rangeY - self._range;
                var result = "";
                var resultX = self._x + self.speedX;
                var resultY = self._y + self.speedY;

                if (resultX <= self._range) {
                    result += "-x";
                } else if (resultX >= rangeX) {
                    result += "+x";
                }
                if (resultY <= self._range) {
                    result += "-y";
                } else if (resultY >= rangeY) {
                    result += "+y";
                }

                return result;
            }

        }

        class point extends WORLDRULE {
            constructor(x, y, World) {
                super();
                let self = this;
                self._x = x || 0;
                self._y = y || 0;
                self._World = World || self._World;
                self._range = 1;
                self._effectRange = 100;
                self._isCSP = false;
            }

            init() {
                let self = this;
                self.context = self._World.earth.getContext("2d");
                self.context.fillStyle = "#2E81CE"; //等同于fillStyle="rgba(46,129,206,1)";
                self.move();
            }

            move() {
                let self = this;
                self.context.beginPath();
                self.context.arc(self._x, self._y, self._range, 0, 2 * Math.PI);
                self.context.fill();
            }

            get effectRange() {
                return this._effectRange;
            }

            set x(x) {
                this._x = x;
            }

            set y(y) {
                this._y = y;
            }

            get x() {
                return this._x;
            }

            get y() {
                return this._y;
            }

            set uid(uid) {
                let self = this;
                TIME.off('objectMove' + self._uid);
                self._uid = uid;
                TIME.on(self.calculate.bind(self), 'objectMove' + self._uid);
            }

            // isConnectSuperPower
            set isCSP(flag) {
                this._isCSP = flag;
            }

            // isConnectSuperPower
            get isCSP() {
                return this._isCSP;
            }

            destroy() {
                let self = this;
                TIME.off('objectMove' + self._uid);
                self.context.fillRect(self._x - self._range, self._y - self._range, 2 * self._range, 2 * self._range);
                self._x = 0;
                self._y = 0;
                self._range = 0;
                self.speedX = 0;
                self.speedY = 0;
                self._effectRange = 100;
            }

        }

        let randomInt = (max) => {
            // return parseInt(Math.random() * max) || randomInt(max);
            return (Math.random() * max) || randomInt(max);
        }

        let mousePoint = null;

        let mouseMove = (e) => {
            if (!mousePoint) {
                mousePoint = new point(e.offsetX, e.offsetY, WORLD);
                mousePoint.uid = "superPower";
                mousePoint.init();
                WORLD.add(mousePoint);
            }
            mousePoint.x = e.offsetX;
            mousePoint.y = e.offsetY;
        }

        let mouseOut = (e) => {
            WORLD.remove(mousePoint);
            mousePoint = null;
        }

        const TIME = new __TIME(1000);
        const WORLD = new __WORLD(WIDTH, HEIGHT);
        WORLD.loaded = () => {

            for (let i = 0; i < 30; i++) {
                let p = new point(randomInt(WIDTH), randomInt(HEIGHT), WORLD);
                p.init();
                p.addSpeedX(randomInt(4));
                p.addSpeedY(randomInt(4));
                WORLD.add(p);
            }

            WORLD.earth.addEventListener('mousemove', mouseMove);
            WORLD.earth.addEventListener('mouseout', mouseOut);
        }

    </script>
</head>

<body style="width:100%;height:100%;">

</body>

</html>